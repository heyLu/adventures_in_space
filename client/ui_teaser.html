<!DOCTYPE html>
<html>
<head>
	<title>Simple UI teaser</title>
	<meta charset="utf-8" />

	<link href='http://fonts.googleapis.com/css?family=Russo+One' rel='stylesheet' type='text/css'>
	<style type="text/css">
	body {
		font-family: "Russo One", sans-serif;
		background-color: #000;
	}
	
	input {
		width: 6em;
	}

	#stars, #stars_blink1, #stars_blink2, #stars_blink3, #space {
		position: fixed;
		left: 0;
		top: 0
	}

	@keyframes fade {
		0% { opacity: 0.2 }
		50% { opacity: 1.0 }
		100% { opacity: 0.2 }
	}

	#stars_blink1 { animation: fade 3s infinite }
	#stars_blink2 { animation: fade 5s infinite }
	#stars_blink3 { animation: fade 7s infinite }

	#space {
		cursor: none;
	}

	#overlay {
		position: fixed;
		top: 0;
		right: 1em;

		color: white;
	}

	#points { font-size: larger }

	#controlbar {
		position: fixed;
		bottom: 0;

		width: 100%;

		background-color: #222;
		color: #aaa;
		border-top: 1px dotted #fff;
	}
</style>
</head>

<body>

<canvas id="stars">
</canvas>

<canvas id="stars_blink1">
</canvas>

<canvas id="stars_blink2">
</canvas>

<canvas id="stars_blink3">
</canvas>

<canvas id="space">
Sorry, but we really need the canvas.
</canvas>

<section id="overlay">
	<p id="points">0</p>
	<p id="velocity">0</p>
	<p id="time_left">âˆž</p>
</section>

<footer id="controlbar">
	<label>
		Acceleration:
		<input type="number" min="0" max="100" value="10" />
	</label>

	<label>
		Direction:
		<input type="number" min="0" max="360" value="0" />
	</label>
	<label>
		P-Mass (kg):
		<input type="number" id="pmass" min="1" max="500" value="1" onchange="calc_projectile_velocity()" />
	</label>
	<label>
		P-Energy (J):
		<input type="number" id="penergy" min="1" max="999999" value="1" onchange="calc_projectile_velocity()" />
	</label>
	<label>
		P-Vel (m/s):
		<input  id="pvel" readonly="readonly" value="" />
	</label>
</footer>

</body>

<script language="javascript">
function calc_projectile_velocity() {
	var m = document.getElementById( "pmass" ).value;
	var e = document.getElementById( "penergy" ).value;
	var t = document.getElementById( "pvel" );
	t.value = Math.sqrt(e/m);
}

window.addEventListener('load', function() {
	function starColor(n, maxVal) {
		var n     = Math.floor(n / maxVal * 6 || Math.random() * 6),
		    color = "#fff";

		switch(n) {
			case 0,1: color = "#fff"; break;
			case   2: color = "#005"; break;
			case   3: color = "#700"; break;
			case   4: color = "#aaa"; break;
			case   5: color = "#666"; break;
			default : color = "#fff"
		}

		return color;
	}

	window.ShipUI = function() {
		ShipUI.name = "ShipUI";

		/* Collect the element given by ids into an object for convenience
		   access. */
		function ShipUI(ids) {
			for (var i = 0; i < ids.length; i++) {
				var id     = ids[i],
				    result = document.getElementById(id);

				if(result) {
					this[id] = result;
				}
			}

			return this;
		}

		return ShipUI;
	}();

	window.StarField = function() {
		StarField.name = "StarField";

		/* Create a new StarField. Give it at least a canvas and
		   optionally the number of stars to create, canvas width and
		   canvas height. */
		function StarField(canvas, n, width, height)  {
			var width  = width  || window.innerWidth,
			    height = height || window.innerHeight;

			canvas.width  = width;
			canvas.height = height;

			this.canvas= canvas;
			this.ctx   = canvas.getContext('2d');
			this.n     = n || width * height * 0.001;
			this.stars = [];

			return this;
		}

		/* Clears the canvas and draws the StarField on it. */
		StarField.prototype.draw = function() {
			this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);

			for(var i = 0; i < this.n; i++) {
					this.stars[i] = [Math.random() * this.canvas.width,  // x
					                 Math.random() * this.canvas.height, // y
					                 starColor(i, this.n),               // colour
					                 Math.floor(Math.random() * 2) + 1]; // size
					this.ctx.fillStyle = this.stars[i][2];
					this.ctx.fillRect(this.stars[i][0], this.stars[i][1], this.stars[i][3], this.stars[i][3]);
			}
		}

		return StarField;
	}()

	var space = document.getElementById('space'),
	    ctx   = space.getContext('2d'),
	    sternleinStehen = window.innerWidth * window.innerHeight * 0.001,
	    starField = new StarField(document.getElementById('stars'), sternleinStehen * 0.4),
	    blink1 = new StarField(document.getElementById('stars_blink1'), sternleinStehen * 0.1),
	    blink2 = new StarField(document.getElementById('stars_blink2'), sternleinStehen * 0.1),
	    blink3 = new StarField(document.getElementById('stars_blink3'), sternleinStehen * 0.1),
	    controlbar = document.getElementById('controlbar');


	space.width  = window.innerWidth;
	space.height = window.innerHeight;
	starField.draw();
	blink1.draw();
	blink2.draw();
	blink3.draw();

	space.onmousemove = function(ev) {
		ctx.clearRect(0, 0, space.width, space.height);

		ctx.fillStyle = "#f00";
		ctx.beginPath();
		ctx.arc(ev.clientX, ev.clientY, 10, 0, 360);
		ctx.fill();
	}

	var ad = window.adventures = {
		world: null,
		ui:    null, //new ShipUI(["pmass", "penergy", "pvel", "points", "velocity", "time_left"]),
		space: ctx,
		starFields: [starField, blink1, blink2, blink3],
		stop: false
	}

	var loginRequest = new XMLHttpRequest();
	loginRequest.open('GET', "http://localhost:8081/login");
	loginRequest.onreadystatechange = function(ev) {
		if (ev.target.readyState != 4) {
			return;
		}

		ad.shipId = JSON.parse(ev.target.responseText).id;
	}
	loginRequest.send();

	window.setInterval(function() {
		if (ad.stop) {
			return;
		}

		var req = new XMLHttpRequest();
		req.open('GET', "http://localhost:8081/world");
		req.onreadystatechange = function(ev) {
			if (ev.target.readyState != 4) {
				return;
			}

			console.log(ev.target.responseText);
			ad.world = JSON.parse(ev.target.responseText);
		}
		req.send();
	}, 1000);

	window.setInterval(function() {
		if (ad.world == null) {
			return;
		}

		ad.space.clearRect(0, 0, ad.space.canvas.width, ad.space.canvas.height);

		for(var i = 0; i < ad.world.ships.length; i++) {
			var ship = ad.world.ships[i];

			ad.space.fillStyle = "#fff";
			ad.space.fillRect(ship.position.x, ship.position.y, ship.size, ship.size);
		}

		for(var i = 0; i < ad.world.projectiles.length; i++) {
			var projectile = ad.world.projectiles[i],
			    size = Math.max(2, projectile.size);

			ad.space.fillStyle = "#fff";
			ad.space.fillRect(projectile.position.x, projectile.position.y, size, size);
		}

	}, 500);
}, false);
</script>
<script language="javascript" src="prefixfree.min.js"></script>
</html>
